# «Сервис сбора метрик и алертинга»

Я.Практикум: Курс — Golang advanced

Реализовано:

- Агент по сбору рантайм-метрик, который собирает метрики и отправляет метрики по протоколу HTTP.
- Сервер по сбору рантайм-метрик, который собирает репорты от агентов по протоколу HTTP, отображает их различными способами

## Настройки приложений

Приложения можно настраивать через переменные окружения или через аргументы, флаги. Приоритет для значений полученных через переменные окружения

Агент:

- `ADDRESS` или `-a`: адрес на который будут отправляться метрики (по умолчанию `http://127.0.0.1:8080`)
- `POLL_INTERVAL` или `-p`: интервал обновления метрик (по умолчанию `2s`)
- `REPORT_INTERVAL` или `-r`: интервал отправки метрик (по умолчанию `10s`)
- `KEY` или `-k`: если указан ключ, то каждая метрика будет хэшироваться с его использованием
- `CRYPTO_KEY` или `-crypto-key`: путь до файла с публичным ключем, если указан, то все запросы, содержащие тело, будут шифроваться

Сервер:

- `ADDRESS` или `-a`: адрес на котором запускается сервер  (по умолчанию `:8080`)

- `DATABASE_DSN` или `-d`: если указан, то сервер будет использовать базу данных (по умолчанию используется кэширование)

- `REDIS_ADDR` или `-redis_addr`: если указан, то сервер будет использовать Redis (приоритет для DATABASE_DSN)
- `REDIS_PASSWORD` или `-redis_psw`: пароль Redis (опционально)
- `REDIS_DB` или `-redis_db`: база данных Redis (по-умолчанию: 0)

- `STORE_FILE` или `-f`: указывается путь файла, если указан, то сервер будет сохранять все метрики в JSON формате в этот файл(по умолчанию `/tmp/devops-metrics-db.json`)
- `STORE_INTERVAL` или `-i`: интервал обновления метрик в файле (по умолчанию `1s`)
- `RESTORE` или `-r`: восстановление метрик из файла при запуске программы (по умолчанию `true`)
- `TRUSTED_SUBNET` или `-t`: если не указано, сервер будет работать со всеми адресами. В противном случае, требуется указать строку CIDR для бесклассовой адресации.
- `KEY` или `-k`: если указан ключ, то перед обновлением каждой метрики будет проверена хэш-сумма метрики, с использованием ключа
- `CRYPTO_KEY` или `-crypto-key`: путь до файла с приватным ключем, если указан, то все запросы, содержащие тело, будут расшифровываться

В docker-compose настроен запуск приложений, используется Redis.
Для тестирования:

```bash
docker-compose up
```

## HTTP API

- `GET /` — главаная страница, отображаются все доступные метрики;
- `GET /value/{metric_type}/{metric_name}` — получить значение метрики;
- `POST /value/` — получить значение метрики (в теле указывается название и тип метрики, в формате JSON);
- `POST /update/{metric_type}/{metric_name}/{value}` — обновить/добавить значение метрики;
- `POST /update/` — обновить/добавить значение метрики (в теле указывается название, тип метрики и значение, в формате JSON);
- `POST /updates/` — обновляет значения для массива метрик, отправленных в теле запроса, в JSON-формате.

Пример метрики в JSON-формате:

```json
{
    "id": "test_metric",
    "type": "gauge",
    "value": "123.321"
}
```
